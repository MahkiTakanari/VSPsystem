# VSPS - 振動刺激提示システム MATLAB制御スクリプト

本フォルダには、積層型ピエゾアクチュエータを用いた振動刺激提示システム（VSPS）をMATLABから制御・記録するためのスクリプトが含まれています。  
本システムは、ヒトの振動知覚閾値を測定する目的で設計されています。

---

■ ファイル一覧

| ファイル名                             | 内容 |
|----------------------------------------|------|
| main_script.m                         | 実験全体の制御スクリプト（複数試行を管理） |
| initDaq.m                             | NI DAQの初期化（ai0: 加速度、ai1: フットスイッチ、サンプリング設定、バッファ確保） |
| initFG.m                              | ファンクションジェネレータ（WF1974）とのVISA接続設定 |
| setupFG.m                             | 波形種別（SIN, +FS）、周波数、初期振幅などの初期設定 |
| startFG.m                             | 出力開始（:OUTP ON） |
| stopFG.m                              | 出力停止（:OUTP OFF） |
| stepFGAmplitudeUntilTrigger.m        | 1秒ごとに振幅を変化（上昇または下降）し、スイッチ入力で停止するメイン測定関数 |
| saveTrialCSV.m                       | [時刻, 加速度, スイッチ電圧] をCSVで保存 |
| saveTriggerTime.m                    | トリガ時刻（秒）をテキストファイルで保存 |

---

■ 実験システム構成

- **振動源**：積層型ピエゾアクチュエータ
- **電圧印加**：WF1974 ファンクションジェネレータ（VISA/SCPI制御）
- **変位計測**：加速度センサ（チャージアンプ経由でai0に接続）
- **知覚検出**：フットスイッチ（プルダウン回路で構成し、ai1に接続）

---

■ 測定条件（推奨）

- サンプリング周波数：8192 Hz
- 最大測定時間：180秒
- 振幅増加（または減少）ステップ：0.5 V/秒
- フットスイッチのON判定しきい値：1.5 V

---

■ 使用方法

1. `main_script.m` を実行
2. `initDaq` / `initFG` / `setupFG` によりDAQとFGを構成
3. `startFG` で出力開始
4. `stepFGAmplitudeUntilTrigger` により振幅を1秒ごとに変化
   - `initAmp = 0` で上昇系列
   - `initAmp >= 1.0` で下降系列（0Vに達すると終了）
5. 被験者が振動を知覚したタイミングでフットスイッチを押すと、トリガ時刻と振幅を記録
6. 10秒間出力を保持した後、`stopFG` で停止
7. 測定データを `saveTrialCSV.m` と `saveTriggerTime.m` により保存
8. 試行を繰り返す

---

■ 備考

- VISAアドレス（WF1974の接続先）は `initFG.m` 内で設定してください
- 任意波形モードは使用せず、SCPIコマンドでリアルタイムに振幅を変更しています
- 実験中はリアルタイム可視化を行わず、後解析用に記録データを保存します

---

※ 今後、加速度 → 変位変換、トリガ時の変位推定などを行う解析スクリプトを追加予定
